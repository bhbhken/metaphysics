# Redis怎么实现分布式锁

## 1 分布式锁的注意事项

- 互斥性：任意时刻，只有一个资源能够获取到锁。
- 容灾性：在未成功释放锁的的情况下，一定时限内能够恢复锁的正常功能。
- 统一性：加锁和解锁保证同一资源来进行操作。

## 2 Redis 怎么实现分布式锁？

**简单方案：**

最简单的方法是使用 setnx 命令。释放锁的最简单方式是执行 del 指令。

**问题：**

锁超时：如果一个得到锁的线程在执行任务的过程中挂掉，来不及显式地释放锁，这块资源将会永远被锁住（死锁），别的线程再也别想进来。

**优化方案：**

setnx 没办法设置超时时间，如果利用 expire 来设置超时时间，那么这两步操作不是原子性操作。

利用 set 指令增加了可选参数方式来替代 setnx。set 指令可以设置超时时间。

## 3 分布式锁常见的方案

- **Memcached 分布式锁**

Memcached 提供了原子性操作命令 add，才能 add 成功，线程获取到锁。key 已存在的情况下，则 add 失败，获取锁也失败。

- **Redis 分布式锁**

Redis 的 setnx 命令为原子性操作命令。只有在 key 不存在的情况下，才能 set 成功。和 Memcached 的 add 方法比较类似。

- **ZooKeeper 分布式锁**

利用 ZooKeeper 的顺序临时节点，来实现分布式锁和等待队列。

- **Chubby 实现分布式锁**

Chubby 底层利用了 Paxos 一致性算法，实现粗粒度分布式锁服务。

